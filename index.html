<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pytwask &#8212; pytwask 0.2.3 documentation</title>
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="pytwask" href="source/modules.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">
          pytwask</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Modules:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="source/modules.html">pytwask</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">pytwask</a></li>
<li><a class="reference internal" href="#table-of-contents">Table of Contents</a></li>
<li><a class="reference internal" href="#features">1. Features</a></li>
<li><a class="reference internal" href="#backend-database">2. Backend database</a></li>
<li><a class="reference internal" href="#mtv-architecture">3. MTV architecture</a></li>
<li><a class="reference internal" href="#deployment">4. Deployment</a><ul>
<li><a class="reference internal" href="#deploy-the-flask-application-in-the-cloud">4.1. Deploy the Flask application in the cloud.</a><ul>
<li><a class="reference internal" href="#install-python-3-6-pip-pip3-virtualenvwrapper">4.1.1. Install Python 3.6, pip, pip3, virtualenvwrapper.</a></li>
<li><a class="reference internal" href="#create-a-separate-user-which-will-run-the-flask-application">4.1.2. Create a separate user which will run the Flask application.</a></li>
<li><a class="reference internal" href="#create-the-virtual-environment-for-running-the-flask-application">4.1.3. Create the virtual environment for running the Flask application.</a></li>
<li><a class="reference internal" href="#install-the-python-wsgi-http-server-gunicorn-and-the-flask-application-pytwask-in-the-above-virtual-environment-flask-apps">4.1.4. Install the Python WSGI HTTP server <code class="docutils literal notranslate"><span class="pre">Gunicorn</span></code> and the Flask application <code class="docutils literal notranslate"><span class="pre">pytwask</span></code> in the above virtual environment <code class="docutils literal notranslate"><span class="pre">flask-apps</span></code>.</a></li>
<li><a class="reference internal" href="#install-and-configure-nginx">4.1.5. Install and configure nginx.</a></li>
<li><a class="reference internal" href="#start-a-gunicorn-process-to-serve-the-flask-application">4.1.6. Start a Gunicorn process to serve the Flask application.</a></li>
<li><a class="reference internal" href="#optional-create-a-systemd-unit-file-and-enable-the-gunicorn-process-as-a-service">4.1.7. (Optional) Create a systemd unit file and enable the Gunicorn process as a service.</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deploy-the-flask-application-via-docker">4.2. Deploy the Flask application via docker.</a><ul>
<li><a class="reference internal" href="#install-docker-and-docker-compose">4.2.1 Install docker and docker-compose.</a></li>
<li><a class="reference internal" href="#download-the-docker-compose-yml-file">4.2.2 Download the docker-compose yml file.</a></li>
<li><a class="reference internal" href="#build-services">4.2.3 Build services.</a></li>
<li><a class="reference internal" href="#create-and-start-containers">4.2.4 Create and start containers.</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting">4.3. Troubleshooting</a><ul>
<li><a class="reference internal" href="#errors-while-reloading-bashrc-for-virtualenvwrapper">4.3.1. Errors while reloading .bashrc for virtualenvwrapper.</a></li>
<li><a class="reference internal" href="#errors-while-installing-nginx">4.3.2. Errors while installing nginx.</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#development">5. Development</a></li>
<li><a class="reference internal" href="#pep8">6. PEP8</a></li>
<li><a class="reference internal" href="#readme-rst">7. README.rst</a></li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="source/modules.html" title="Next Chapter: pytwask"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">pytwask &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="_sources/index.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">pytwask</a></li>
<li><a class="reference internal" href="#table-of-contents">Table of Contents</a></li>
<li><a class="reference internal" href="#features">1. Features</a></li>
<li><a class="reference internal" href="#backend-database">2. Backend database</a></li>
<li><a class="reference internal" href="#mtv-architecture">3. MTV architecture</a></li>
<li><a class="reference internal" href="#deployment">4. Deployment</a><ul>
<li><a class="reference internal" href="#deploy-the-flask-application-in-the-cloud">4.1. Deploy the Flask application in the cloud.</a><ul>
<li><a class="reference internal" href="#install-python-3-6-pip-pip3-virtualenvwrapper">4.1.1. Install Python 3.6, pip, pip3, virtualenvwrapper.</a></li>
<li><a class="reference internal" href="#create-a-separate-user-which-will-run-the-flask-application">4.1.2. Create a separate user which will run the Flask application.</a></li>
<li><a class="reference internal" href="#create-the-virtual-environment-for-running-the-flask-application">4.1.3. Create the virtual environment for running the Flask application.</a></li>
<li><a class="reference internal" href="#install-the-python-wsgi-http-server-gunicorn-and-the-flask-application-pytwask-in-the-above-virtual-environment-flask-apps">4.1.4. Install the Python WSGI HTTP server <code class="docutils literal notranslate"><span class="pre">Gunicorn</span></code> and the Flask application <code class="docutils literal notranslate"><span class="pre">pytwask</span></code> in the above virtual environment <code class="docutils literal notranslate"><span class="pre">flask-apps</span></code>.</a></li>
<li><a class="reference internal" href="#install-and-configure-nginx">4.1.5. Install and configure nginx.</a></li>
<li><a class="reference internal" href="#start-a-gunicorn-process-to-serve-the-flask-application">4.1.6. Start a Gunicorn process to serve the Flask application.</a></li>
<li><a class="reference internal" href="#optional-create-a-systemd-unit-file-and-enable-the-gunicorn-process-as-a-service">4.1.7. (Optional) Create a systemd unit file and enable the Gunicorn process as a service.</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deploy-the-flask-application-via-docker">4.2. Deploy the Flask application via docker.</a><ul>
<li><a class="reference internal" href="#install-docker-and-docker-compose">4.2.1 Install docker and docker-compose.</a></li>
<li><a class="reference internal" href="#download-the-docker-compose-yml-file">4.2.2 Download the docker-compose yml file.</a></li>
<li><a class="reference internal" href="#build-services">4.2.3 Build services.</a></li>
<li><a class="reference internal" href="#create-and-start-containers">4.2.4 Create and start containers.</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting">4.3. Troubleshooting</a><ul>
<li><a class="reference internal" href="#errors-while-reloading-bashrc-for-virtualenvwrapper">4.3.1. Errors while reloading .bashrc for virtualenvwrapper.</a></li>
<li><a class="reference internal" href="#errors-while-installing-nginx">4.3.2. Errors while installing nginx.</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#development">5. Development</a></li>
<li><a class="reference internal" href="#pep8">6. PEP8</a></li>
<li><a class="reference internal" href="#readme-rst">7. README.rst</a></li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>

  <li>
    <a href="source/modules.html" title="Next Chapter: pytwask"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">pytwask &raquo;</span>
    </a>
  </li>
<div id="sourcelink">
  <a href="_sources/index.rst.txt"
     rel="nofollow">Source</a>
</div>
<form action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="pytwask">
<h1>pytwask<a class="headerlink" href="#pytwask" title="Permalink to this headline">¶</a></h1>
<p><strong>Source code and development docker image:</strong> <a class="reference external" href="https://travis-ci.org/renweizhukov/pytwask"><img alt="Code Build Status" src="https://travis-ci.org/renweizhukov/pytwask.svg?branch=master" /></a></p>
<p><strong>Production docker image:</strong> <a class="reference external" href="https://travis-ci.org/renweizhukov/docker-pytwask"><img alt="Docker Build Status" src="https://travis-ci.org/renweizhukov/docker-pytwask.svg?branch=master" /></a></p>
<p>A toy-twitter-clone frontend using Python and Flask.</p>
<p>To run this Flask application locally in the production mode,</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install pytwask
$ export FLASK_APP=autopytwask
$ export PYTWASK_ENV=prod
$ flask run
</pre></div>
</div>
<p>For how to run the application in the development mode, please refer to
<a class="reference external" href="#5-development">Section 5</a>.</p>
<p>For how to deploy the application via docker, please refer to <a class="reference external" href="#42-deploy-the-flask-application-via-docker">Section
4.2</a>.</p>
</div>
<div class="section" id="table-of-contents">
<h1>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference external" href="#1-features">1. Features</a></li>
<li><a class="reference external" href="#2-backend-database">2. Backend database</a></li>
<li><a class="reference external" href="#3-mtv-architecture">3. MTV architecture</a></li>
<li><a class="reference external" href="#4-deployment">4. Deployment</a><ul>
<li><a class="reference external" href="#41-deploy-the-flask-application-in-the-cloud">4.1. Deploy the Flask application in the
cloud.</a><ul>
<li><a class="reference external" href="#411-install-python-36-pip-pip3-virtualenvwrapper">4.1.1. Install Python 3.6, pip, pip3,
virtualenvwrapper.</a></li>
<li><a class="reference external" href="#412-create-a-separate-user-which-will-run-the-flask-application">4.1.2. Create a separate user which will run the Flask
application.</a></li>
<li><a class="reference external" href="#413-create-the-virtual-environment-for-running-the-flask-application">4.1.3. Create the virtual environment for running the Flask
application.</a></li>
<li><a class="reference external" href="#414-install-the-python-wsgi-http-server-gunicorn-and-the-flask-application-pytwask-in-the-above-virtual-environment-flask-apps">4.1.4. Install the Python WSGI HTTP server Gunicorn and the
Flask application pytwask in the above virtual environment
flask-apps.</a></li>
<li><a class="reference external" href="#415-install-and-configure-nginx">4.1.5. Install and configure
nginx.</a></li>
<li><a class="reference external" href="#416-start-a-gunicorn-process-to-serve-the-flask-application">4.1.6. Start a Gunicorn process to serve the Flask
application.</a></li>
<li><a class="reference external" href="#417-optional-create-a-systemd-unit-file-and-enable-the-gunicorn-process-as-a-service">4.1.7. (Optional) Create a systemd unit file and enable the
Gunicorn process as a
service.</a></li>
</ul>
</li>
<li><a class="reference external" href="#42-deploy-the-flask-application-via-docker">4.2. Deploy the Flask application via
docker.</a><ul>
<li><a class="reference external" href="#421-install-docker-and-docker-compose">4.2.1 Install docker and
docker-compose.</a></li>
<li><a class="reference external" href="#422-download-the-docker-compose-yml-file">4.2.2 Download the docker-compose yml
file.</a></li>
<li><a class="reference external" href="#423-build-services">4.2.3 Build services.</a></li>
<li><a class="reference external" href="#424-create-and-start-containers">4.2.4 Create and start
containers.</a></li>
</ul>
</li>
<li><a class="reference external" href="#43-troubleshooting">4.3. Troubleshooting</a><ul>
<li><a class="reference external" href="#431-errors-while-reloading-bashrc-for-virtualenvwrapper">4.3.1. Errors while reloading .bashrc for
virtualenvwrapper.</a></li>
<li><a class="reference external" href="#432-errors-while-installing-nginx">4.3.2. Errors while installing
nginx.</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference external" href="#5-development">5. Development</a></li>
<li><a class="reference external" href="#6-pep8">6. PEP8</a></li>
<li><a class="reference external" href="#7-readmerst">7. README.rst</a></li>
</ul>
</div>
<div class="section" id="features">
<h1>1. Features<a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h1>
<p>This module implements the frontend for a simplified Twitter clone based
on Flask.</p>
<p>It supports the following features:</p>
<ul class="simple">
<li>Register new users</li>
<li>Log in/out</li>
<li>Change user password</li>
<li>Get user profile</li>
<li>Post tweets</li>
<li>Follower/Following</li>
<li>General timeline for anonymous user</li>
<li>User timeline</li>
<li>Get tweets posted by one user</li>
</ul>
<p>TODOs:</p>
<ul class="simple">
<li>Search users</li>
<li>Delete a user</li>
<li>Recover user password</li>
<li>#hashtags</li>
<li>&#64;mentions</li>
<li>Retweets</li>
<li>Replies</li>
<li>Conversations</li>
<li>Edit/Delete tweets</li>
<li>And more</li>
</ul>
</div>
<div class="section" id="backend-database">
<h1>2. Backend database<a class="headerlink" href="#backend-database" title="Permalink to this headline">¶</a></h1>
<p>Although currently we only have Redis as the only type of backend
database, we can easily switch to another type of backend database as
long as the backend module conforms to the same interface as the Redis
backend module <code class="docutils literal notranslate"><span class="pre">pytwis</span></code>.</p>
<p>By default this Flask application will connect to the Redis database via
a TCP/IP connection. To connect to a local Redis database via a UNIX
domain socket, define the environment variable <code class="docutils literal notranslate"><span class="pre">REDIS_DB_SOCKET</span></code> as
the socket file (e.g., <code class="docutils literal notranslate"><span class="pre">/tmp/redis.sock</span></code>) before running the
application.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ export REDIS_DB_SOCKET=&quot;/tmp/redis.sock&quot;
$ export FLASK_APP=autopytwask
$ flash run
</pre></div>
</div>
<p>Note that the UNIX domain socket is by default disabled in Redis and you
need to manually enable it in the Redis configuration file (usually
<code class="docutils literal notranslate"><span class="pre">/etc/redis/redis.conf</span></code>) before use it.</p>
</div>
<div class="section" id="mtv-architecture">
<h1>3. MTV architecture<a class="headerlink" href="#mtv-architecture" title="Permalink to this headline">¶</a></h1>
<p>This Flask application follows the typical Flask Model-Template-View
pattern. Its directory layout follows the ones given at</p>
<ul class="simple">
<li><a class="reference external" href="http://flask.pocoo.org/docs/0.12/patterns/packages/">http://flask.pocoo.org/docs/0.12/patterns/packages/</a></li>
<li><a class="reference external" href="http://flask.pocoo.org/docs/0.12/patterns/appfactories/#app-factories">http://flask.pocoo.org/docs/0.12/patterns/appfactories/#app-factories</a></li>
<li><a class="reference external" href="http://flask.pocoo.org/docs/0.12/cli/">http://flask.pocoo.org/docs/0.12/cli/</a></li>
</ul>
<p>Specifically,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── autopytwask.py    # The Flask script which creates this Flask application
└── pytwask
    ├── auth          # The authentication blueprint
    ├── config.py     # The Flask application configuration file
    ├── __init__.py
    ├── main          # The main blueprint
    ├── models.py     # The data Model
    ├── static        # The HTML resources (css, images, javascript)
    ├── templates     # The HTML Templates
    └── tweets        # The tweets blueprint
</pre></div>
</div>
</div>
<div class="section" id="deployment">
<h1>4. Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h1>
<div class="section" id="deploy-the-flask-application-in-the-cloud">
<h2>4.1. Deploy the Flask application in the cloud.<a class="headerlink" href="#deploy-the-flask-application-in-the-cloud" title="Permalink to this headline">¶</a></h2>
<p>Take the Amazon Web Service (AWS) as an example. Assume that we have
created an EC2 instance with Ubuntu 16.04LTS, exposed its HTTP port 80,
and SSH’ed into it.</p>
<div class="section" id="install-python-3-6-pip-pip3-virtualenvwrapper">
<h3>4.1.1. Install Python 3.6, pip, pip3, virtualenvwrapper.<a class="headerlink" href="#install-python-3-6-pip-pip3-virtualenvwrapper" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">Install</span> <span class="n">Python</span> <span class="mf">3.6</span> <span class="kn">from</span> <span class="nn">source.</span>
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span># Download the latest source release of Python 3.6.
$ wget https://www.python.org/ftp/python/3.6.5/Python-3.6.5.tgz

# Unpack the downloaded archive.
$ tar -xvf Python-3.6.5.tgz

# Build and install.
$ cd Python-3.6.5
$ ./configure
$ make
$ make install

# Verify the installation.
$ python3.6 -V
Python 3.6.5
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">Install</span> <span class="n">pip</span> <span class="ow">and</span> <span class="n">pip3</span><span class="o">.</span>
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt install python-pip python3-pip
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="n">Install</span> <span class="n">virtualenvwrapper</span><span class="o">.</span>
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pip3 install virtualenvwrapper
</pre></div>
</div>
</div>
<div class="section" id="create-a-separate-user-which-will-run-the-flask-application">
<h3>4.1.2. Create a separate user which will run the Flask application.<a class="headerlink" href="#create-a-separate-user-which-will-run-the-flask-application" title="Permalink to this headline">¶</a></h3>
<p>We should never run the Flask application as root. If we do that, once
the Flask application is compromised somehow, the attacker will gain
access to the entire system.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo adduser flask-apps
</pre></div>
</div>
</div>
<div class="section" id="create-the-virtual-environment-for-running-the-flask-application">
<h3>4.1.3. Create the virtual environment for running the Flask application.<a class="headerlink" href="#create-the-virtual-environment-for-running-the-flask-application" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(1) Set up `virtualenvwrapper` for the user `flask-apps`.
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo su - flask-apps
$ vi ~/.bashrc
</pre></div>
</div>
<p>Add the following lines in <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export WORKON_HOME=$HOME/.virtualenvs
export VIRTUALENVWRAPPER_VIRTUALENV_ARGS=&#39;--no-site-packages&#39;
source /usr/local/bin/virtualenvwrapper.sh
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(2) Reload `.bashrc` and create a virtual environment for running the Flask application.
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd
$ source .bashrc
$ mkvirtualenv -p /usr/bin/python3.6 pytwask
</pre></div>
</div>
<p>Note that the binary location of <code class="docutils literal notranslate"><span class="pre">python3.6</span></code> may vary on different
machines but it can be easily found by <code class="docutils literal notranslate"><span class="pre">which</span> <span class="pre">python3.6</span></code>.</p>
</div>
<div class="section" id="install-the-python-wsgi-http-server-gunicorn-and-the-flask-application-pytwask-in-the-above-virtual-environment-flask-apps">
<h3>4.1.4. Install the Python WSGI HTTP server <code class="docutils literal notranslate"><span class="pre">Gunicorn</span></code> and the Flask application <code class="docutils literal notranslate"><span class="pre">pytwask</span></code> in the above virtual environment <code class="docutils literal notranslate"><span class="pre">flask-apps</span></code>.<a class="headerlink" href="#install-the-python-wsgi-http-server-gunicorn-and-the-flask-application-pytwask-in-the-above-virtual-environment-flask-apps" title="Permalink to this headline">¶</a></h3>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span># After mkvirtualenv is done, the virtual environment flask-apps should be automatically activated.
# But if not, we can manually activate it.
$ workon pytwask

(pytwask) $ pip install gunicorn pytwask
</pre></div>
</div>
</div>
<div class="section" id="install-and-configure-nginx">
<h3>4.1.5. Install and configure nginx.<a class="headerlink" href="#install-and-configure-nginx" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">Install</span> <span class="n">nginx</span><span class="o">.</span>
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span># Exit the user flask-apps
$ exit

$ sudo apt install nginx
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(2) Configure nginx to proxy requests.

* Optimize the nginx parameter `default_type` for the Flask application.

According to http://www.patricksoftwareblog.com/how-to-configure-nginx-for-a-flask-web-application/, for a Flask application that is generating dynamic HTML files, the parameter `default_type` should be changed to: `default_type text/html;`.
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo vi /etc/nginx/nginx.conf
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="p">{</span>
    <span class="o">......</span>

    <span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">mime</span><span class="o">.</span><span class="n">types</span><span class="p">;</span>
    <span class="n">default_type</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="c1"># was application/octet-stream</span>

    <span class="o">......</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">configuration</span> <span class="n">file</span> <span class="k">for</span> <span class="n">pytwask</span><span class="o">.</span>
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo vi /etc/nginx/sites-available/pytwask
</pre></div>
</div>
<p>Note that we will pass requests to the socket we defined using the
<code class="docutils literal notranslate"><span class="pre">proxy_pass</span></code> directive.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">server</span> <span class="p">{</span>
    <span class="n">listen</span>      <span class="mi">80</span><span class="p">;</span>
    <span class="n">server_name</span> <span class="p">[</span><span class="n">SERVER_DNS_NAME</span> <span class="n">OR</span> <span class="n">SERVER_IP</span><span class="p">];</span>

    <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="n">include</span> <span class="n">proxy_params</span><span class="p">;</span>
        <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">unix</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pytwask</span><span class="o">.</span><span class="n">sock</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>* Enable the above server configuration by linking the file to the `sites-enabled` directory.
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo ln -s /etc/nginx/sites-available/pytwask /etc/nginx/sites-enabled
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">Test</span> <span class="n">the</span> <span class="n">configuration</span> <span class="n">file</span> <span class="k">for</span> <span class="n">syntax</span> <span class="n">error</span><span class="o">.</span>
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo nginx -t
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">Restart</span> <span class="n">nginx</span> <span class="n">to</span> <span class="n">load</span> <span class="n">the</span> <span class="n">new</span> <span class="n">configuration</span><span class="o">.</span>
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo service nginx restart
</pre></div>
</div>
</div>
<div class="section" id="start-a-gunicorn-process-to-serve-the-flask-application">
<h3>4.1.6. Start a Gunicorn process to serve the Flask application.<a class="headerlink" href="#start-a-gunicorn-process-to-serve-the-flask-application" title="Permalink to this headline">¶</a></h3>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo su - flask-apps

# Here we use the UNIX domain socket to connect to the Redis database.
# If you want to use the TCP/IP connection, then don&#39;t define the environment variable REDIS_DB_SOCKET.
$ export PYTWASK_ENV=prod
$ export REDIS_DB_SOCKET=&quot;/tmp/redis.sock&quot;
$ export REDIS_DB_PASSWORD=&quot;[PASSWORD]&quot;

$ workon pytwask
(pytwask) $ gunicorn -b unix:/tmp/pytwask.sock -m 007 -w 4 autopytwask:app &amp;
</pre></div>
</div>
<p>Note that the ampersand “&amp;” will set the Gunicorn process off running in
the background.</p>
</div>
<div class="section" id="optional-create-a-systemd-unit-file-and-enable-the-gunicorn-process-as-a-service">
<h3>4.1.7. (Optional) Create a systemd unit file and enable the Gunicorn process as a service.<a class="headerlink" href="#optional-create-a-systemd-unit-file-and-enable-the-gunicorn-process-as-a-service" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(1) Create a unit file ending in `.service` within the directory `/etc/systemd/system`.
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo vi /etc/systemd/system/pytwask.service
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(2) Add the section `[Unit]` to specify metadata and dependencies.
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Gunicorn</span> <span class="n">instance</span> <span class="n">to</span> <span class="n">serve</span> <span class="n">pytwask</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(3) Add the section `[Service]` to specify:

* the user `flask-apps` and group `www-data` that we want the process to run under;
* the working directory and set various environment variables;
* the command to start the service.

Note that we give the group ownership to group `www-data` so that nginx can communicate easily with the Gunicorn process.
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Gunicorn</span> <span class="n">instance</span> <span class="n">to</span> <span class="n">serve</span> <span class="n">pytwask</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">User</span><span class="o">=</span><span class="n">flask</span><span class="o">-</span><span class="n">apps</span>
<span class="n">Group</span><span class="o">=</span><span class="n">www</span><span class="o">-</span><span class="n">data</span>
<span class="n">WorkingDirectory</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">flask</span><span class="o">-</span><span class="n">apps</span><span class="o">/.</span><span class="n">virtualenvs</span>
<span class="n">Environment</span><span class="o">=</span><span class="s2">&quot;PATH=/home/flask-apps/.virtualenvs/pytwask/bin&quot;</span>
<span class="n">Environment</span><span class="o">=</span><span class="s2">&quot;PYTWASK_ENV=prod&quot;</span>
<span class="n">Environment</span><span class="o">=</span><span class="s2">&quot;REDIS_DB_SOCKET=/tmp/redis.sock&quot;</span>
<span class="n">Environment</span><span class="o">=</span><span class="s2">&quot;REDIS_DB_PASSWORD=[PASSWORD]&quot;</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">flask</span><span class="o">-</span><span class="n">apps</span><span class="o">/.</span><span class="n">virtualenvs</span><span class="o">/</span><span class="n">pytwask</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gunicorn</span> <span class="o">-</span><span class="n">b</span> <span class="n">unix</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pytwask</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">m</span> <span class="mi">007</span> <span class="o">-</span><span class="n">w</span> <span class="mi">4</span> <span class="n">autopytwask</span><span class="p">:</span><span class="n">app</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(4) Add the section `[Install]` to tell systemd what to link this service to if we enable it to start at boot.
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Gunicorn</span> <span class="n">instance</span> <span class="n">to</span> <span class="n">serve</span> <span class="n">pytwask</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">User</span><span class="o">=</span><span class="n">flask</span><span class="o">-</span><span class="n">apps</span>
<span class="n">Group</span><span class="o">=</span><span class="n">www</span><span class="o">-</span><span class="n">data</span>
<span class="n">WorkingDirectory</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">flask</span><span class="o">-</span><span class="n">apps</span><span class="o">/.</span><span class="n">virtualenvs</span>
<span class="n">Environment</span><span class="o">=</span><span class="s2">&quot;PATH=/home/flask-apps/.virtualenvs/pytwask/bin&quot;</span>
<span class="n">Environment</span><span class="o">=</span><span class="s2">&quot;PYTWASK_ENV=prod&quot;</span>
<span class="n">Environment</span><span class="o">=</span><span class="s2">&quot;REDIS_DB_SOCKET=/tmp/redis.sock&quot;</span>
<span class="n">Environment</span><span class="o">=</span><span class="s2">&quot;REDIS_DB_PASSWORD=[PASSWORD]&quot;</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">flask</span><span class="o">-</span><span class="n">apps</span><span class="o">/.</span><span class="n">virtualenvs</span><span class="o">/</span><span class="n">pytwask</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gunicorn</span> <span class="o">-</span><span class="n">b</span> <span class="n">unix</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pytwask</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">m</span> <span class="mi">007</span> <span class="o">-</span><span class="n">w</span> <span class="mi">4</span> <span class="n">autopytwask</span><span class="p">:</span><span class="n">app</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">Start</span> <span class="n">the</span> <span class="n">Gunicorn</span> <span class="n">service</span> <span class="ow">and</span> <span class="n">enable</span> <span class="n">it</span> <span class="n">to</span> <span class="n">start</span> <span class="n">at</span> <span class="n">boot</span><span class="o">.</span>
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo systemctl start pytwask
$ sudo systemctl enable pytwask
</pre></div>
</div>
</div>
</div>
<div class="section" id="deploy-the-flask-application-via-docker">
<h2>4.2. Deploy the Flask application via docker.<a class="headerlink" href="#deploy-the-flask-application-via-docker" title="Permalink to this headline">¶</a></h2>
<p>Via docker, this flask application can be deployed not only on Linux but
also on Windows, but note that <strong>when it is deployed on Docker for
Windows, we need to switch to Linux containers</strong>.</p>
<div class="section" id="install-docker-and-docker-compose">
<h3>4.2.1 Install docker and docker-compose.<a class="headerlink" href="#install-docker-and-docker-compose" title="Permalink to this headline">¶</a></h3>
<p>For docker, see <a class="reference external" href="https://docs.docker.com/install/">https://docs.docker.com/install/</a>.</p>
<p>For docker-compose, see
<a class="reference external" href="https://docs.docker.com/compose/install/#install-compose">https://docs.docker.com/compose/install/#install-compose</a>.</p>
</div>
<div class="section" id="download-the-docker-compose-yml-file">
<h3>4.2.2 Download the docker-compose yml file.<a class="headerlink" href="#download-the-docker-compose-yml-file" title="Permalink to this headline">¶</a></h3>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ wget https://raw.githubusercontent.com/renweizhukov/docker-pytwask/master/docker-compose.yml
</pre></div>
</div>
</div>
<div class="section" id="build-services">
<h3>4.2.3 Build services.<a class="headerlink" href="#build-services" title="Permalink to this headline">¶</a></h3>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker-compose build
</pre></div>
</div>
</div>
<div class="section" id="create-and-start-containers">
<h3>4.2.4 Create and start containers.<a class="headerlink" href="#create-and-start-containers" title="Permalink to this headline">¶</a></h3>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker-compose up -d
</pre></div>
</div>
<p>To stop and remove containers, networks, images, and volumes,</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker-compose down -v
</pre></div>
</div>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>4.3. Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<div class="section" id="errors-while-reloading-bashrc-for-virtualenvwrapper">
<h3>4.3.1. <a class="reference external" href="https://stackoverflow.com/questions/33216679/usr-bin-python3-error-while-finding-spec-for-virtualenvwrapper-hook-loader">Errors while reloading .bashrc for virtualenvwrapper</a>.<a class="headerlink" href="#errors-while-reloading-bashrc-for-virtualenvwrapper" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/usr/bin/python3: Error while finding spec for &#39;virtualenvwrapper.hook_loader&#39; (&lt;class &#39;ImportError&#39;&gt;: No module named &#39;virtualenvwrapper&#39;)
</pre></div>
</div>
<p>To fix this, install <code class="docutils literal notranslate"><span class="pre">python3-pip</span></code> and then install
<code class="docutils literal notranslate"><span class="pre">virtualenvwrapper</span></code> from <code class="docutils literal notranslate"><span class="pre">pip3</span></code>.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt install python3-pip
$ sudo pip3 install virtualwrapperenv
</pre></div>
</div>
</div>
<div class="section" id="errors-while-installing-nginx">
<h3>4.3.2. <a class="reference external" href="https://askubuntu.com/questions/764222/nginx-installation-error-in-ubuntu-16-04">Errors while installing nginx</a>.<a class="headerlink" href="#errors-while-installing-nginx" title="Permalink to this headline">¶</a></h3>
<p>To fix this, stop apache2 before installing nginx.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo service apache2 stop
</pre></div>
</div>
<p>As a further step, we may disable apache2 from startup or even remove
apache2.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span># To disable apache2
$ sudo update-rc.d apache2 disable

# To remove apache2
$ sudo update-rc.d -f apache2 remove
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="development">
<h1>5. Development<a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h1>
<p>By default, this Flask application will run in the development mode
where the Flask DebugToolbar is enabled.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/renweizhukov/pytwask.git
$ cd pytwask
$ pip install -e .
$ export FLASK_APP=autopytwask
$ flask run
</pre></div>
</div>
<p>To launch the application in the development mode via docker, first
install docker and docker-compose by following steps given in <a class="reference external" href="#42-deploy-the-flask-application-via-docker">Section
4.2</a>, and then build
services, create and start containers.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/renweizhukov/pytwask.git

# Build services.
$ docker-compose -f docker-compose_dev.yml build

# Create and start containers in the detach mode.
$ docker-compose -f docker-compose_dev.yml up -d
</pre></div>
</div>
<p>To stop and remove containers, networks, images, and volumes,</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker-compose -f docker-compose_dev.yml down -v
</pre></div>
</div>
</div>
<div class="section" id="pep8">
<h1>6. PEP8<a class="headerlink" href="#pep8" title="Permalink to this headline">¶</a></h1>
<p>We use <code class="docutils literal notranslate"><span class="pre">pylint</span></code> to enforce the Python Style Guide PEP8.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ pylint pytwask
</pre></div>
</div>
<p>We have fixed all the convention violations, warnings, and errors in the
package <code class="docutils literal notranslate"><span class="pre">pytwask</span></code>.</p>
</div>
<div class="section" id="readme-rst">
<h1>7. README.rst<a class="headerlink" href="#readme-rst" title="Permalink to this headline">¶</a></h1>
<p>README.rst is generated from README.md via <code class="docutils literal notranslate"><span class="pre">pandoc</span></code>.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ pandoc --from=markdown --to=rst --output=README.rst README.md
</pre></div>
</div>
<div class="toctree-wrapper compound">
<p class="caption"><span class="caption-text">Modules:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="source/modules.html">pytwask</a><ul>
<li class="toctree-l2"><a class="reference internal" href="source/pytwask.html">pytwask package</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></li>
<li><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></li>
<li><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></li>
</ul>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2018, Wei Ren.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>